!function(e,t){var n,r={},i=function(e,t){var n,r,i;if("string"==typeof e)return s(e);for(n=[],r=e.length,i=0;r>i;i++)n.push(s(e[i]));return t.apply(null,n)},o=function(e,t,n){2===arguments.length&&(n=t,t=null),i(t||[],function(){a(e,n,arguments)})},a=function(e,t,n){var o,a={exports:t};"function"==typeof t&&(n.length||(n=[i,a.exports,a]),o=t.apply(null,n),void 0!==o&&(a.exports=o)),r[e]=a.exports},s=function(t){var n=r[t]||e[t];if(!n)throw new Error("`"+t+"` is undefined");return n},u=function(e){var t,n,i,o,a,s;s=function(e){return e&&e.charAt(0).toUpperCase()+e.substr(1)};for(t in r)if(n=e,r.hasOwnProperty(t)){for(i=t.split("/"),a=s(i.pop());o=s(i.shift());)n[o]=n[o]||{},n=n[o];n[a]=r[t]}},c=t(e,o,i);u(c),n=e.WebUploader,e.WebUploader=c,e.WebUploader.noConflict=function(){e.WebUploader=n}}(this,function(e,t,n){return t("guid",[],function(){function e(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function t(t){var n=(new Date).valueOf(),t=t||"";return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()+"-"+n+t}return t}),t("hex_md5",[],function(){function e(e){return n(t(r(e)))}function t(e){return o(a(i(e),8*e.length))}function n(e){try{}catch(t){h=0}for(var n,r=h?"0123456789ABCDEF":"0123456789abcdef",i="",o=0;o<e.length;o++)n=e.charCodeAt(o),i+=r.charAt(15&n>>>4)+r.charAt(15&n);return i}function r(e){for(var t,n,r="",i=-1;++i<e.length;)t=e.charCodeAt(i),n=i+1<e.length?e.charCodeAt(i+1):0,t>=55296&&56319>=t&&n>=56320&&57343>=n&&(t=65536+((1023&t)<<10)+(1023&n),i++),127>=t?r+=String.fromCharCode(t):2047>=t?r+=String.fromCharCode(192|31&t>>>6,128|63&t):65535>=t?r+=String.fromCharCode(224|15&t>>>12,128|63&t>>>6,128|63&t):2097151>=t&&(r+=String.fromCharCode(240|7&t>>>18,128|63&t>>>12,128|63&t>>>6,128|63&t));return r}function i(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(var n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}function o(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(255&e[n>>5]>>>n%32);return t}function a(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;for(var n=1732584193,r=-271733879,i=-1732584194,o=271733878,a=0;a<e.length;a+=16){var s=n,d=r,h=i,g=o;n=u(n,r,i,o,e[a+0],7,-680876936),o=u(o,n,r,i,e[a+1],12,-389564586),i=u(i,o,n,r,e[a+2],17,606105819),r=u(r,i,o,n,e[a+3],22,-1044525330),n=u(n,r,i,o,e[a+4],7,-176418897),o=u(o,n,r,i,e[a+5],12,1200080426),i=u(i,o,n,r,e[a+6],17,-1473231341),r=u(r,i,o,n,e[a+7],22,-45705983),n=u(n,r,i,o,e[a+8],7,1770035416),o=u(o,n,r,i,e[a+9],12,-1958414417),i=u(i,o,n,r,e[a+10],17,-42063),r=u(r,i,o,n,e[a+11],22,-1990404162),n=u(n,r,i,o,e[a+12],7,1804603682),o=u(o,n,r,i,e[a+13],12,-40341101),i=u(i,o,n,r,e[a+14],17,-1502002290),r=u(r,i,o,n,e[a+15],22,1236535329),n=c(n,r,i,o,e[a+1],5,-165796510),o=c(o,n,r,i,e[a+6],9,-1069501632),i=c(i,o,n,r,e[a+11],14,643717713),r=c(r,i,o,n,e[a+0],20,-373897302),n=c(n,r,i,o,e[a+5],5,-701558691),o=c(o,n,r,i,e[a+10],9,38016083),i=c(i,o,n,r,e[a+15],14,-660478335),r=c(r,i,o,n,e[a+4],20,-405537848),n=c(n,r,i,o,e[a+9],5,568446438),o=c(o,n,r,i,e[a+14],9,-1019803690),i=c(i,o,n,r,e[a+3],14,-187363961),r=c(r,i,o,n,e[a+8],20,1163531501),n=c(n,r,i,o,e[a+13],5,-1444681467),o=c(o,n,r,i,e[a+2],9,-51403784),i=c(i,o,n,r,e[a+7],14,1735328473),r=c(r,i,o,n,e[a+12],20,-1926607734),n=l(n,r,i,o,e[a+5],4,-378558),o=l(o,n,r,i,e[a+8],11,-2022574463),i=l(i,o,n,r,e[a+11],16,1839030562),r=l(r,i,o,n,e[a+14],23,-35309556),n=l(n,r,i,o,e[a+1],4,-1530992060),o=l(o,n,r,i,e[a+4],11,1272893353),i=l(i,o,n,r,e[a+7],16,-155497632),r=l(r,i,o,n,e[a+10],23,-1094730640),n=l(n,r,i,o,e[a+13],4,681279174),o=l(o,n,r,i,e[a+0],11,-358537222),i=l(i,o,n,r,e[a+3],16,-722521979),r=l(r,i,o,n,e[a+6],23,76029189),n=l(n,r,i,o,e[a+9],4,-640364487),o=l(o,n,r,i,e[a+12],11,-421815835),i=l(i,o,n,r,e[a+15],16,530742520),r=l(r,i,o,n,e[a+2],23,-995338651),n=f(n,r,i,o,e[a+0],6,-198630844),o=f(o,n,r,i,e[a+7],10,1126891415),i=f(i,o,n,r,e[a+14],15,-1416354905),r=f(r,i,o,n,e[a+5],21,-57434055),n=f(n,r,i,o,e[a+12],6,1700485571),o=f(o,n,r,i,e[a+3],10,-1894986606),i=f(i,o,n,r,e[a+10],15,-1051523),r=f(r,i,o,n,e[a+1],21,-2054922799),n=f(n,r,i,o,e[a+8],6,1873313359),o=f(o,n,r,i,e[a+15],10,-30611744),i=f(i,o,n,r,e[a+6],15,-1560198380),r=f(r,i,o,n,e[a+13],21,1309151649),n=f(n,r,i,o,e[a+4],6,-145523070),o=f(o,n,r,i,e[a+11],10,-1120210379),i=f(i,o,n,r,e[a+2],15,718787259),r=f(r,i,o,n,e[a+9],21,-343485551),n=p(n,s),r=p(r,d),i=p(i,h),o=p(o,g)}return Array(n,r,i,o)}function s(e,t,n,r,i,o){return p(d(p(p(t,e),p(r,o)),i),n)}function u(e,t,n,r,i,o,a){return s(t&n|~t&r,e,t,i,o,a)}function c(e,t,n,r,i,o,a){return s(t&r|n&~r,e,t,i,o,a)}function l(e,t,n,r,i,o,a){return s(t^n^r,e,t,i,o,a)}function f(e,t,n,r,i,o,a){return s(n^(t|~r),e,t,i,o,a)}function p(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function d(e,t){return e<<t|e>>>32-t}var h=0;return e}),t("crc32",[],function(){for(var t="00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".split(" "),n=new Array,r=0;r<t.length;++r)n[r]=parseInt("0x"+t[r]);var i=function(t,r){r==e.undefined&&(r=0);var i=0;r=-1^r;for(var o=0,a=t.length;a>o;o++)i=255&(r^t.charCodeAt(o)),r=r>>>8^n[i];var s=-1^r;return 0>s&&(s=4294967295+s+1),s};return i}),t("dollar",[],function(){return e.jQuery||e.Zepto}),t("promise-third",["dollar"],function(e){return{Deferred:e.Deferred,when:e.when,isPromise:function(e){return e&&"function"==typeof e.then}}}),t("promise",["promise-third"],function(e){return e}),t("base",["dollar","promise"],function(t,n){function r(e){return function(){return u.apply(e,arguments)}}function i(e,t){return function(){return e.apply(t,arguments)}}function o(e){var t;return Object.create?Object.create(e):(t=function(){},t.prototype=e,new t)}function a(){var t={};return e.FileReader&&(t=new FileReader),e.FormData&&e.FileReader&&t.readAsBinaryString&&e.XMLHttpRequest}var s=function(){},u=Function.call;return{version:"1.0.0",$:t,Deferred:n.Deferred,isPromise:n.isPromise,when:n.when,browser:function(e){var t={},n=e.match(/WebKit\/([\d.]+)/),r=e.match(/Chrome\/([\d.]+)/)||e.match(/CriOS\/([\d.]+)/),i=e.match(/MSIE\s([\d.]+)/),o=e.match(/Firefox\/([\d.]+)/),a=e.match(/Safari\/([\d.]+)/),s=e.match(/OPR\/([\d.]+)/);return n&&(t.webkit=parseFloat(n[1])),r&&(t.chrome=parseFloat(r[1])),i&&(t.ie=parseFloat(i[1])),o&&(t.firefox=parseFloat(o[1])),a&&(t.safari=parseFloat(a[1])),s&&(t.opera=parseFloat(s[1])),t}(navigator.userAgent),os:function(e){var t={},n=e.match(/(?:Android);?[\s\/]+([\d.]+)?/),r=e.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);return n&&(t.android=parseFloat(n[1])),r&&(t.ios=parseFloat(r[1].replace(/_/g,"."))),t}(navigator.userAgent),inherits:function(e,n,r){var i;return"function"==typeof n?(i=n,n=null):i=n&&n.hasOwnProperty("constructor")?n.constructor:function(){return e.apply(this,arguments)},t.extend(!0,i,e,r||{}),i.__super__=e.prototype,i.prototype=o(e.prototype),n&&t.extend(!0,i.prototype,n),i},noop:s,bindFn:i,log:function(){return e.console?i(console.log,console):s}(),nextTick:function(){return function(e){setTimeout(e,1)}}(),slice:r([].slice),guid:function(){var e=0;return function(t){for(var n=(+new Date).toString(32),r=0;5>r;r++)n+=Math.floor(65535*Math.random()).toString(32);return(t||"wu_")+n+(e++).toString(32)}}(),parseJson:function(e){var t;try{t=JSON.parse(e)}catch(n){t={}}return t},formatSize:function(e,t,n){var r;for(n=n||["B","K","M","G","TB"];(r=n.shift())&&e>1024;)e/=1024;return("B"===r?e:e.toFixed(t||2))+r},isSupportHtml5:a}}),t("mediator",["base"],function(e){function t(e,t,n,r){return o.grep(e,function(e){return!(!e||t&&e.e!==t||n&&e.cb!==n&&e.cb._cb!==n||r&&e.ctx!==r)})}function n(e,t,n){o.each((e||"").split(s),function(e,r){n(r,t)})}function r(e,t){for(var n,r=!1,i=-1,o=e.length;++i<o;)if(n=e[i],n.cb.apply(n.ctx2,t)===!1){r=!0;break}return!r}var i,o=e.$,a=[].slice,s=/\s+/;return i={on:function(e,t,r){var i,o=this;return t?(i=this._events||(this._events=[]),n(e,t,function(e,t){var n={e:e};n.cb=t,n.ctx=r,n.ctx2=r||o,n.id=i.length,i.push(n)}),this):this},once:function(e,t,r){var i=this;return t?(n(e,t,function(e,t){var n=function(){return i.off(e,n),t.apply(r||i,arguments)};n._cb=t,i.on(e,n,r)}),i):i},off:function(e,r,i){var a=this._events;return a?e||r||i?(n(e,r,function(e,n){o.each(t(a,e,n,i),function(){delete a[this.id]})}),this):(this._events=[],this):this},trigger:function(e){var n,i,o;return this._events&&e?(n=a.call(arguments,1),i=t(this._events,e),o=t(this._events,"all"),r(i,n)&&r(o,arguments)):this}},o.extend({installTo:function(e){return o.extend(e,i)}},i)}),t("file",["base","mediator"],function(e,t){function n(){return o+a++}function r(e){var t=this;this.name=e.name||e.fileName||"Untitled",this.size=e.size||e.fileSize||0,this.type=e.type||"application",this.lastModifiedDate=e.lastModifiedDate||1*new Date,this.id=n(),this.ext=s.exec(this.name)?RegExp.$1:"",this.statusText="",u[this.id]=r.Status.INITED,this.source=e,this.loaded=0,this.on("error",function(e){this.setStatus(r.Status.ERROR,e)}),this.slice=function(e,n){var r=t.source,i=r.slice||r.webkitSlice||r.mozSlice;return i.call(r,e,n)}}var i=e.$,o="WU_FILE_",a=0,s=/\.([^.]+)$/,u={};return i.extend(r.prototype,{setStatus:function(e,t){var n=u[this.id];"undefined"!=typeof t&&(this.statusText=t),e!==n&&(u[this.id]=e,this.trigger("statuschange",e,n))},getStatus:function(){return u[this.id]},getSource:function(){return this.source},destory:function(){delete u[this.id]}}),t.installTo(r.prototype),r.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"},r}),t("filepicker",["base","file","mediator"],function(e,t,n){function r(e){var t,n,o,a,s=this,e=this.options=i.extend({},r.options,e),u=e.owner,c=i(document.getElementById(e.id)),l=i(document.createElement("div")),f=i(document.createElement("label")),p=i(document.createElement("input"));if(c.find(".webuploader-shim-container").remove(),c.css("position","relative"),!c.length)throw new Error("按钮指定错误");if(l.addClass("webuploader-shim-container"),a=function(e){u.trigger(e.type)},this.container=c,this.owner=u,p.attr("type","file"),p.attr("name",e.name),p.addClass("webuploader-element-invisible"),f.on("click",function(){p.trigger("click")}),f.css({opacity:0,width:"100%",height:"100%",display:"block",cursor:"pointer",background:"#ffffff"}),f.on("mouseenter mouseleave",a),l.css({width:c.outerWidth(),height:c.outerHeight(),position:"absolute",left:0,top:0}),e.multiple&&p.attr("multiple","multiple"),e.accept&&e.accept.length>0){for(t=[],n=0,o=e.accept.length;o>n;n++)t.push(e.accept[n].mimeTypes);p.attr("accept",t.join(","))}p.on("change",function(e){var t,n,r=arguments.callee;n=e.target.files,t=this.cloneNode(!0),this.parentNode.replaceChild(t,this),p.off(),p=i(t).on("change",r).on("mouseenter mouseleave",a),n&&s.trigger("select",n)}),l.append(p),l.append(f),c.append(l)}var i=e.$;return r.options={button:null,container:null,label:null,multiple:!0,accept:null,name:"file"},r.prototype={constructor:r,init:function(){var e=this;setTimeout(function(){e.trigger("ready")},1)},refresh:function(){},enable:function(){var e=this.options,t=i(document.getElementById(e.id));t.find(".webuploader-shim-container").css("top","0"),t.removeClass("webuploader-pick-disable")},disable:function(){var e=this.options,t=i(document.getElementById(e.id));t.find(".webuploader-shim-container").css("top","-999999px"),t.addClass("webuploader-pick-disable")},destroy:function(){}},n.installTo(r.prototype),r}),t("iframeuploader",["base","mediator"],function(t){function n(){var e=null;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){e=!1}}}return e}function r(e){var t=e||{};this.alert=t.alert||function(e){alert(e)},this.init(t)}var i=t.$;t.log;var o=1,a={"Not accept, Bucket not exists":"不接受请求,空间不存在","Authorize has expired":"不接受请求,上传授权已过期","Not accept, Miss signature":"不接受请求,缺少签名","Not accept, Signature error":"签名错误","Not accept, POST URI error":"不接受请求","Not accept, Bucket disabled":"不接受请求,空间被禁用","Not accept, Form API disabled":"不接受请求,表单 API 功能未打开","Not accept, No file data":"不接受请求,没有上传文件数据","Not accept, File too large":"不接受请求,上传文件过大 ","Not accept, File too small":"不接受请求,上传文件过小 ","Not accept, File type Error":"不接受请求,上传文件类型不允许","Not accept, Content­md5 error":"不接受请求,上传文件的内容 md5 校验错误","Not accept, Not a image file":"不接受请求,上传的不是图片文件","Not accept, Image width too small":"不接受请求,上传的图片宽度过小 ","Not accept, Image width too large":"不接受请求,上传的图片宽度过大 ","Not accept, Image height too small":"不接受请求,上传的图片高度过小","Not accept, Image height too large":"不接受请求,上传的图片高度过大 ","Not accept, Data too long for ext-param":" 额外参数内容过长","Image Rotate Invalid Parameters":"图片旋转参数错误","Image Crop Invalid Parameters":"图片裁剪参数错误","System Error ... Retry again":"系统错误,请再尝试"};return r.options={server:"/api/1.1b/file/upload/full/upload"},r.prototype={constructor:r,init:function(e){if(i.isPlainObject(e.accept)){e.accept=[e.accept];for(var t=[],n=0,a=e.accept.length;a>n;n++){var s=e.accept[n].extensions;s&&t.push(s)}t.length&&(accept="\\."+t.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$"),this.accept=new RegExp(accept,"i")}this.opts=i.extend({},r.options,e),this.success=e.success?e.success:this.success,this.fail=e.fail?e.fail:this.fail,this.iframeName="uploaderIframe",this.uuid=o++,this._formData={returnurl:"http://"+location.host+"/api/1.1b/file/upyun/form/uploadcallback_"+this.uuid},this.createForm(),this.createCallback(),this.createIframe()},parseJson:function(e){var t;try{t=JSON.parse(e)}catch(n){t={}}return t},addURLParam:function(e,t,n){return e+=-1==e.indexOf("?")?"?":"&",e+=encodeURIComponent(t)+"="+encodeURIComponent(n)},upload:function(){var e,t=this,r=this.opts,i=t.fileField,o=i.value,a=(this.container,r.token),s=a.data||{},u=this._formData,c=/\.\w+$/,l="http://"+location.host+"/api/1.1b/file/upload/token/get";if(o){if(e=t.file=this.getFile(o),this.accept&&c.exec(e.name)&&!this.accept.test(e.name))return console.warn("类型不匹配"),void 0;r.beforeStart&&r.beforeStart();for(var f in s)l=t.addURLParam(l,f,s[f]);l=t.addURLParam(l,"from",location.host);var p=n(),d=function(){var e=p.responseText,n=t.parseJson(e),r=n.data||{},i=r.token;u.tasktoken=i,t.createHiddenField(),t.form.submit()};p.onerror=function(){t.fail({message:"获取token失败"})},p.onreadystatechange=function(){4===p.readyState&&(200==p.status?d():(console.warn("iframe 获取token失败"),t.fail({message:"获取token失败"})))},p.open("GET",l,!0),p.send(null)}},parseError:function(e){var e=e||{},t=e.message;e.message=t=t.replace(/\+/g," "),e.message=t=decodeURIComponent(t);for(var n in a)if(n==t){e.message=a[n];break}return e.message=e.message.replace("Not accept, File type Error (Only Accept","文件类型不支持，(仅支持:"),e},emptyFileField:function(){var e=this;e.fileField.value=""},createHiddenField:function(){var e=this._formData,t=i(this.form);this.opts.server,t.find(".iframeuploader-hidden-field").remove();for(var n in e)t.append('<input type="hidden" name="'+n+'" value="'+e[n]+'" class="iframeuploader-hidden-field">')},createForm:function(){var e,t=this,n=this.opts,r=n.pick,o=r.id,a=this.uuid,s=this._formData,u=i('<div class="webuploader-iframe-container"></div>'),c='<form action="" name="iframeuploaderForm" enctype="multipart/form-data" method="post"></form>',l=i('<input type="file" name="file" class="webuploader-iframe-file">'),f="webuploader-container-"+a,p=i("#"+o),d=p[0],h=function(e){for(;e.parentNode;){var t=e.tagName.toLowerCase();if("body"===t)return null;if("form"===t)return e;e=e.parentNode}return null};if(p.find(".webuploader-iframe-container").remove(),u.attr("id",f),p.append(u),this.container=i(document.getElementById(f)),e=h(d),e?(this.form=e,this.container.append(l)):(this.container.append(c),this.form=this.container.find("form")[0],i(this.form).append(l)),this.fileField=this.container.find('input[name="file"]')[0],this.readyForm(),n.accept&&n.accept.length>0){for(var g=[],m=0,v=n.accept.length;v>m;m++)g.push(n.accept[m].mimeTypes);i(this.fileField).attr("accept",g.join(","))}i(this.fileField).bind("change",function(){var e=t.getFile(this.value);t.form,e&&(s.name=e.name,t.opts.auto&&t.upload())})},getFile:function(e){var e=e||"",t=this.getFileName(e),n=this.getFileExt(t);return e?{name:t,ext:n}:null},getFileExt:function(e){var e=e||"",t=e.split(".");return t[1]?t[1].toLowerCase():""},getFileName:function(e){var t,e=e||"",n=e.lastIndexOf("\\");return e?t=n>-1?e.substring(n+1):e:""},createCallback:function(){var t=this,n=t.uuid;e["upload_callback_"+n]=function(e){var n,r=t.file;0==e.code?(t.emptyFileField(),t.success&&t.success.call(t,r,e)):(n=t.parseError(e),t.fail&&t.fail.call(t,r,n))}},createIframe:function(){var e,t=this,n=t.iframeName;document.getElementById(n)||(e=document.createElement("iframe"),e.name=e.id=n,e.style.display="none",document.body.appendChild(e))},readyForm:function(){var e=this.opts;this.form.action=e.server,this.form.encoding="multipart/form-data",this.form.setAttribute("enctype","multipart/form-data"),this.form.setAttribute("method","post"),this.form.setAttribute("target",this.iframeName)},changeToken:function(e){this.opts.token||{},this.opts.token=e},fail:function(e){var e=e||{};e.message||"",alert(e.message)}},r}),t("uploader",["base","mediator","iframeuploader"],function(t,n,r){function i(t){o.isPlainObject(t.accept)&&(t.accept=[t.accept]),this.opts=this.options=o.extend(!0,{},i.options,t),this.alert=t.alert||function(t){e.alert(t)},t.beforeStart&&"function"==typeof t.beforeStart&&this.on("startUpload",function(){t.beforeStart.call(this)}),t.progress&&"function"==typeof t.progress&&this.on("uploadProgress",function(e,n){t.progress.call(this,e,n)}),t.success&&"function"==typeof t.success&&this.on("uploadSuccess",function(e,n){t.success.call(this,e,n.data)}),t.fail&&"function"==typeof t.fail&&this.on("uploadError",function(e,n){t.fail.call(this,e,n)}),this._init(this.options)}var o=t.$;t.log,i.options={},n.installTo(i.prototype),o.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",getInfo:"getInfo",carryon:"carryon",reset:"reset"},function(e,t){i.prototype[e]=function(){return this.request(t,arguments)}}),o.extend(i.prototype,{state:"pending",_init:function(e){var t=this;t.request("init",e,function(){t.state="ready",t.trigger("ready")})},changeToken:function(e){this.opts.token||{},this.opts.token=e},option:function(e,t){var n=this.options;return arguments.length>1?(o.isPlainObject(t)&&o.isPlainObject(n[e])?o.extend(n[e],t):n[e]=t,void 0):e?n[e]:n},getStats:function(){var e=this.request("get-stats");return{successNum:e.numOfSuccess,cancelNum:e.numOfCancel,invalidNum:e.numOfInvalid,uploadFailNum:e.numOfUploadFailed,queueNum:e.numOfQueue}},trigger:function(e){var t=[].slice.call(arguments,1),r=this.options,i="on"+e.substring(0,1).toUpperCase()+e.substring(1);return n.trigger.apply(this,arguments)===!1||o.isFunction(r[i])&&r[i].apply(this,t)===!1||o.isFunction(this[i])&&this[i].apply(this,t)===!1||n.trigger.apply(n,[this,e].concat(t))===!1?!1:!0},getImgDataUrl:function(e,t,n){var r=e.source,i=new FileReader;return e.type.match(/^image/)?(i.onload=function(){t&&t(this.result)},i.onerror=function(){n&&n()},i.readAsDataURL(r),void 0):(n&&n(),void 0)},request:t.noop});var a=function(t){var n=this,r=t||{},i=r.pick||{},a=i.id;this.alert=r.alert||function(t){e.alert(t)},o(document.getElementById(a)).bind("click",function(){n.alert("您的浏览器不支持上传插件")})};return n.installTo(a.prototype),t.create=i.create=function(e){return"html5"===e.mode?t.isSupportHtml5()?new i(e):new a(e):"iframe"===e.mode?new r(e):e.multiple?t.isSupportHtml5()?new i(e):new a(e):t.browser.ie&&t.browser.ie<8?new a(e):t.isSupportHtml5()?new i(e):new r(e)},t.Uploader=i,i}),t("widgets/widget",["base","uploader"],function(e,t){function n(e){if(!e)return!1;var t=e.length,n=i.type(e);return 1===e.nodeType&&t?!0:"array"===n||"function"!==n&&"string"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}function r(e){this.owner=e,this.options=e.options}var i=e.$,o=t.prototype._init,a={},s=[];return i.extend(r.prototype,{init:e.noop,invoke:function(e,t){var n=this.responseMap;return n&&e in n&&n[e]in this&&i.isFunction(this[n[e]])?this[n[e]].apply(this,t):a},request:function(){return this.owner.request.apply(this.owner,arguments)}}),i.extend(t.prototype,{_init:function(){var e=this,t=e._widgets=[];return i.each(s,function(n,r){t.push(new r(e))}),o.apply(e,arguments)},request:function(t,r,i){var o,s,u=0,c=this._widgets,l=c.length,f=[],p=[];for(r=n(r)?r:[r];l>u;u++)o=c[u],s=o.invoke(t,r),s!==a&&(e.isPromise(s)?p.push(s):f.push(s));return i||p.length?e.when.apply(e,p).then(function(){var t=e.Deferred(),n=arguments;return setTimeout(function(){t.resolve.apply(t,n)},1),t.promise()}).then(i||e.noop):f[0]}}),t.register=r.register=function(t,n){var o,a={init:"init"};return 1===arguments.length?(n=t,n.responseMap=a):n.responseMap=i.extend(a,t),o=e.inherits(r,n),s.push(o),o},r}),t("widgets/filepicker",["base","uploader","filepicker"],function(e,t,n){var r=e.$;return r.extend(t.options,{pick:null}),t.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(e){return this.pickers=[],e.pick&&this.addButton(e.pick)},refresh:function(){r.each(this.pickers,function(){this.refresh()})},addButton:function(t){var i,o,a,s=this,u=s.options,c=s.owner,l=u.multiple?!0:!1;if(t)return a=e.Deferred(),r.isPlainObject(t)||(t={id:t}),i=r.extend({},t,{owner:c,multiple:l,accept:u.accept}),o=new n(i),o.once("ready",a.resolve),o.on("select",function(e){s.owner.request("add-file",[e])}),o.init(),this.pickers.push(o),a.promise()},disable:function(){r.each(this.pickers,function(){this.disable()})},enable:function(){r.each(this.pickers,function(){this.enable()})}})}),t("queue",["base","mediator","file"],function(e,t,n){function r(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0},this._queue=[],this._map={}}var i=e.$,o=n.Status;return i.extend(r.prototype,{append:function(e){return this._queue.push(e),this._fileAdded(e),this},prepend:function(e){return this._queue.unshift(e),this._fileAdded(e),this},getFile:function(e){return"string"!=typeof e?e:this._map[e]},fetch:function(e){var t,n,r=this._queue.length;for(e=e||o.QUEUED,t=0;r>t;t++)if(n=this._queue[t],e===n.getStatus())return n;return null},sort:function(e){"function"==typeof e&&this._queue.sort(e)},getFiles:function(){for(var e,t=[].slice.call(arguments,0),n=[],r=0,o=this._queue.length;o>r;r++)e=this._queue[r],(!t.length||~i.inArray(e.getStatus(),t))&&n.push(e);return n},_fileAdded:function(e){var t=this,n=this._map[e.id];n||(this._map[e.id]=e,e.on("statuschange",function(e,n){t._onFileStatusChange(e,n)})),e.setStatus(o.QUEUED)},_onFileStatusChange:function(e,t){var n=this.stats;switch(t){case o.PROGRESS:n.numOfProgress--;break;case o.QUEUED:n.numOfQueue--;break;case o.ERROR:n.numOfUploadFailed--;break;case o.INVALID:n.numOfInvalid--}switch(e){case o.QUEUED:n.numOfQueue++;break;case o.PROGRESS:n.numOfProgress++;break;case o.ERROR:n.numOfUploadFailed++;break;case o.COMPLETE:n.numOfSuccess++;break;case o.CANCELLED:n.numOfCancel++;break;case o.INVALID:n.numOfInvalid++}}}),t.installTo(r.prototype),r}),t("transport",["base","mediator"],function(e,t){function n(e){var e=i.extend(!0,{},n.options,e||{});this.options=e,this._formData=e.formData||{},this._headers=e.headers||{},this.init()}var r=e.noop,i=e.$;return e.log,n.options={server:"/api/1.1b/file/upload/chunk/upload",method:"POST",withCredentials:!0,fileVal:"file",timeout:12e4,formData:{},headers:{},sendAsBinary:!1},n.prototype={init:function(){this._status=0,this._response=null},append:function(e,t){"object"==typeof e?i.extend(this._formData,e):this._formData[e]=t},post:function(){var e=this,t=(this.owner,this.options),n=this._initAjax(),r=t.server,i=this._formData;if(i)for(var o in i)r=e.addURLParam(r,o,i[o]);t.withCredentials&&"withCredentials"in n?(n.open("POST",r,!0),n.withCredentials=!0):n.open("POST",r),this._setRequestHeader(n,t.headers),n.send(null)},get:function(){var e=this,t=(this.owner,this.options),n=this._initAjax(),r=t.server,i=this._formData;if(i)for(var o in i)r=e.addURLParam(r,o,i[o]);t.withCredentials&&"withCredentials"in n?(n.open("get",r,!0),n.withCredentials=!0):n.open("get",r),this._setRequestHeader(n,t.headers),n.send(null)},send:function(){var t,n=(this.owner,this.options),r=this._initAjax(),o=n.server,a=n.block,s=a.file,u=s.source,c=u.slice||u.webkitSlice||u.mozSlice,l=c.call(s.source,a.start,a.end),f=a.chunk_crc32,p=s.ext.toLowerCase();e.os.android?(t=new FormData,t.append("tasktoken",n.formData.tasktoken),t.append(n.fileVal,s.source,s.name),r.open("POST","/api/1.1b/file/upload/full/upload"),r.send(t)):(t=new FormData,i.each(this._formData,function(e,n){t.append(e,n)}),t.append("from",location.host),t.append("filetype",p),t.append("chunk_crc32",f),t.append(n.fileVal,l,s.name),n.withCredentials&&"withCredentials"in r?r.open(n.method,o):r.open(n.method,o),this._setRequestHeader(r,n.headers),e.os.android,r.send(t))},getResponse:function(){return this._response},getResponseAsJson:function(){return this._parseJson(this._response)},getStatus:function(){return this._status},abort:function(){var e=this._xhr;e&&(e.upload.onprogress=r,e.onreadystatechange=r,e.abort(),this._xhr=e=null)},destroy:function(){this.abort()},_initAjax:function(){var e=this,t=new XMLHttpRequest,n=this.options;return t.timeout=n.timeout,t.ontimeout=function(){return e.trigger("error",{message:"请求超时了"})},t.upload.onprogress=function(t){var n=0;return t.lengthComputable&&(n=t.loaded/t.total),e.trigger("progress",n)},t.onreadystatechange=function(){return 4===t.readyState?(t.upload.onprogress=r,t.onreadystatechange=r,e._xhr=null,e._status=t.status,200===t.status?(e._response=t.responseText,e.trigger("load",e._parseJson(t.responseText))):t.status>200?(e._response=t.responseText,e.trigger("error",e._parseJson(t.responseText))):e.trigger("error",{type:"http",message:"服务器出错"})):void 0},t.onerror=function(){return e.trigger("error",{type:"http",message:"服务器出错!"})},e._xhr=t,t},_setRequestHeader:function(e,t){i.each(t,function(t,n){e.setRequestHeader(t,n)})},_parseJson:function(e){var t;try{t=JSON.parse(e)}catch(n){t={}}return t},addURLParam:function(e,t,n){return e+=-1==e.indexOf("?")?"?":"&",e+=encodeURIComponent(t)+"="+encodeURIComponent(n)}},t.installTo(n.prototype),n}),t("widgets/upload",["base","uploader","file","transport","crc32","hex_md5","guid"],function(e,t,n,r,i,o,a){function s(e,t){for(var n,r=[],i=e.source,o=i.size,a=t?Math.ceil(o/t):1,s=0,u=0;a>u;)n=Math.min(t,o-s),r.push({file:e,start:s,end:t?s+n:o,total:o,chunks:a,chunk:u++}),s+=n;return e.blocks=r.concat(),e.remaning=r.length,{file:e,has:function(){return!!r.length},fetch:function(t){return t?e.blocks[t-1]:r.shift()}}}var u=e.$,c=e.log,l=e.isPromise,f=n.Status;u.extend(t.options,{fileThreads:3,duplicate:!0,md5_path:"/assets/js/webuploader/md5.js",token:{url:"http://"+location.host+"/api/1.1b/file/upload/token/get",data:{}},prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:0,threads:3,formData:null}),t.register({"after-send-file":"afterSendFile","before-send-file":"beforeSendFile","before-send":"beforeSend","start-upload":"start","stop-upload":"stop","skip-file":"skipFile",reset:"reset",getInfo:"getInfo",carryon:"carryon","is-in-progress":"isInProgress"},{init:function(){var t=this,n=this.owner;this.runing=!1,this.__tick=e.bindFn(this._tick,this),n.on("uploadComplete",function(r){var i=n.getStats();r.blocks&&u.each(r.blocks,function(e,t){t.transport&&(t.transport.abort(),t.transport.destroy()),delete t.transport}),t.remaning||0!==i.queueNum||(t.runing=!1,e.nextTick(function(){t.owner.trigger("uploadFinished")}))})},reset:function(){this.runing=!1},getInfo:function(){var e=this;return{runing:e.runing,pool:e.pool,uploading:e.remaning,pending:e.pending}},afterSendFile:function(t,n){var r=e.Deferred(),n=n||{},i={message:"fail"};return n.data=n.data||{},n.data.url?r.resolve():(i.message=n.message||i.message,r.reject(i)),r.promise()},beforeSend:function(t){var n=this.owner.options,r=(n.BlockMd5,n.CRC32),o=t.file,a=o.filehash,s=t.chunk+1,u=o.source,l=u.slice||u.webkitSlice||u.mozSlice,p=l.call(o.source,t.start,t.end),d=e.Deferred();e.os.android&&(t.chunk_crc32=0,d.resolve(!1));var h=function(t){var n="http://"+location.host+"/api/1.1b/file/upload/resumestatus/get?filehash="+t,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=e.parseJson(r.responseText),n=t.data||{},i=n.url;i?(me.remaning--,owner.trigger("uploadProgress",wufile,1),wufile.setStatus(f.PROGRESS),d.resolve(t)):d.reject({message:"服务器数据传输出错!"})}},r.onerror=function(){var t=e.parseJson(r.responseText);d.reject(t)},r.open("GET",n),r.send(null)},g=function(){var n=new XMLHttpRequest,r="http://"+location.host+"/api/1.1b/file/upload/chunkstatus/get?filehash="+a+"&chunk_id="+s;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var r=e.parseJson(n.responseText),i=r.data.isfinish;t.isfinish=i,i?t.end>=t.total?h():d.resolve(!0):d.resolve(!1)}},n.onerror=function(){var t=e.parseJson(n.responseText);d.reject(t)},n.open("GET",r),n.send(null)},m=function(e){var n=new FileReader;n.onloadend=function(e){if(2==e.target.readyState){var n=i(e.target.result);t.chunk_crc32=n,n?g():d.reject({message:"CRC32计算失败"})}},n.onerror=function(){c("crc32 error"),d.reject({message:"CRC32计算失败"})},n.readAsBinaryString(e)};return 0==r?(t.chunk_crc32=0,g()):m(p),d.promise()},beforeSendFile:function(t){function n(n){var r="http://"+location.host+"/api/1.1b/file/upload/resumestatus/get?filehash="+n,i=new XMLHttpRequest;
i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var n=e.parseJson(i.responseText),r=n.data||{},o=r.chunk_size,a=r.chunk_next_id,s=r.url;s?(p.trigger("uploadProgress",t,1),u.remaning--,t.setStatus(f.PROGRESS),l.resolve(n)):a?(t.chunk_next_id=a,t.chunk_size=o,l.resolve()):l.reject(n)}},i.open("GET",r),i.send(null)}function r(){return function(e){if(e.data.result){var r=e.data.result;t.filehash=o(r+m),n(t.filehash)}}}function i(e,t){var n,r,i,o,a,s,s=function(e){t.postMessage({message:e.target.result,block:r})},a=function(){r.end!==e.size&&(r.start+=n,r.end+=n,r.end>e.size&&(r.end=e.size),i=new FileReader,i.onload=s,o=e.slice(r.start,r.end),i.readAsArrayBuffer(o))};n=1048576,r={file_size:e.size,start:0},r.end=n>e.size?e.size:n,t.addEventListener("message",a),i=new FileReader,i.onload=s,o=e.slice(r.start,r.end),i.readAsArrayBuffer(o)}var s,u=this,c=t.source,l=e.Deferred(),p=this.owner,d=u.options,h=d.token.data.configkey,g=d.filehashStamp?d.filehashStamp:"",m=h+g,v=d.FileMd5;if(e.os.android&&(t.chunk_next_id=1,t.chunk_size=t.size,l.resolve()),t.filehash)n(t.filehash);else if(v===!1){var D=a();t.filehash=o(D+m),n(t.filehash)}else s=new Worker(d.md5_path),s.addEventListener("message",r("md5_file_hash_"+(new Date).valueOf()),!1),i(c,s);return l.promise()},start:function(){var t=this,n=this.owner,i=t.options,o=i.token,a=o.url,s=o.data,c=i.formData||{},l=function(){e.nextTick(t.__tick)};if(!t.runing){u.each(t.request("get-files",f.INVALID),function(){t.request("remove-file",this)}),this.pool=[],this.pending=[],this.remaning=0,t.runing=!0,t._trigged=!1,t.owner.trigger("startUpload"),s.from=location.host;var p=new r({server:a,method:"GET",withCredentials:!0,formData:s});p.on("load",function(e){var t=e.data||{};c.tasktoken=t.token,i.formData=c,l()}),p.on("error",function(e){t.remaning=0,t.runing=!1,n.trigger("error","GET_TOKEN_ERROR",e)}),p.get()}},stop:function(){var e,t,n,r=this,i=this.owner,o=[];for(r.runing=!1,e=i.getFiles(f.PROGRESS),t=0,n=e.length;n>t;t++)file=e[t],file.blocks=file.blocks||[],o=o.concat(file.blocks);u.each(o,function(e,t){t.transport&&t.transport.abort(),t.file.setStatus(f.INTERRUPT)}),r.owner.trigger("stopUpload")},carryon:function(){var e,t,n,r=this,i=this.owner;for(e=i.getFiles(f.INTERRUPT,f.PROGRESS),t=0,n=e.length;n>t;t++)file=e[t],file.setStatus(f.QUEUED);console.log("carryon",e),r.request("start-upload")},isInProgress:function(){return!!this.runing},getStats:function(){return this.request("get-stats")},skipFile:function(e,t){e=this.request("get-file",e),e.setStatus(t||f.COMPLETE),e.skipped=!0,e.blocks&&u.each(e.blocks,function(e,t){var n=t.transport;n&&(n.abort(),n.destroy(),delete t.transport)}),this.owner.trigger("uploadSkip",e)},_tick:function(){var t,n,r=this,i=r.options;return r._promise?r._promise.always(r.__tick):(r.pool.length<i.fileThreads&&r.getStats().numOfQueue&&(n=r._nextFileBlock())&&(r.remaning++,t=function(t){r._promise=null,t&&t.file&&r._startSend(t),e.nextTick(r.__tick)},r._promise=l(n)?n.always(t):t(n)),void 0)},_nextFileBlock:function(){var e,t,n=this,r=n._act;return n.options,!n.pending.length&&n.getStats().numOfQueue&&n._prepareNextFile(),e=n.pending.shift(),t=function(e){return e?(r=s(e,e.chunk_size),r.fetch(e.chunk_next_id)):null},l(e)?e.then(t):t(e)},_prepareNextFile:function(){var t,n=this,r=n.request("fetch-file"),i=n.pending;r&&(t=n.request("before-send-file",r,function(t){return r.getStatus()===f.QUEUED?(n.owner.trigger("uploadStart",r),r.setStatus(f.PROGRESS),r):(e.nextTick(n.__tick),n._finishFile(r,t))}),t.done(function(){var e=u.inArray(t,i);~e&&i.splice(e,1,r)}),t.fail(function(e){r.setStatus(f.ERROR,e),n.owner.trigger("uploadError",r,e),n.owner.trigger("uploadComplete",r)}),i.push(t))},_popBlock:function(e){var t=u.inArray(e,this.pool);this.pool.splice(t,1)},_startSend:function(t){var n,r=this,i=t.file;if(r.pool.push(t),r.runing!==!1){var o=function(e){for(var t=i.blocks||[],n=0;n<e.chunk;n++)t[n].percentage=1};o(t),n=r.request("before-send",t,function(n){if(i.getStatus()===f.PROGRESS)if("boolean"==typeof n&&t.isfinish)t.percentage=1,r._popBlock(t),i.chunk_next_id++,r._startSend(i.blocks[i.chunk_next_id-1]);else{if("object"==typeof n)return e.nextTick(r.__tick),r._finishFile(i,n);r._doSend(t)}else r._popBlock(t),e.nextTick(r.__tick)}),n.fail(function(){r._finishFile(i).always(function(){r.remaning--,t.percentage=1,r._popBlock(t),r.owner.trigger("uploadComplete",i),e.nextTick(r.__tick)})})}},_doSend:function(t){var n=this,i=n.owner,o=u.extend({},n.options,{block:t}),a=t.file,s=new r(o),c=u.extend({},o.formData),l=u.extend({},o.headers);t.transport=s,s.on("destroy",function(){delete t.transport,n._popBlock(t)}),s.on("progress",function(e){var n=0,r=0;n=t.percentage=e,t.chunks>1&&(u.each(a.blocks,function(e,t){r+=(t.percentage||0)*(t.end-t.start)}),n=r/a.size),i.trigger("uploadProgress",a,n||0)}),s.on("error",function(r){t.retried=t.retried||0,t.chunks>1&&t.retried<o.chunkRetry?(t.retried++,s.send()):(n.remaning--,s.trigger("destroy"),a.setStatus(f.ERROR,"server error"),i.trigger("uploadError",a,r),i.trigger("uploadComplete",a),e.nextTick(n.__tick))}),s.on("load",function(t){var r,o=t.data||{},u=o.chunk_next_id;s.trigger("destroy"),o.url?(n.remaning--,n._finishFile(a,t),e.nextTick(n.__tick)):u?(a.chunk_next_id=u,r=a.blocks[u-1],n._startSend(r)):(n.remaning--,a.setStatus(f.ERROR,"server error"),i.trigger("uploadError",a,{message:"上传失败"}),i.trigger("uploadComplete",a),e.nextTick(n.__tick))}),c=u.extend(c,{filename:a.name,filehash:a.filehash,chunk_size:i.options.chunkSize,chunk_id:t.chunk+1,filesize:a.size}),i.trigger("uploadBeforeSend",t,c,l),s.append(c),s.send()},_finishFile:function(e,t,n){var r=this.owner;return r.request("after-send-file",arguments,function(){e.setStatus(f.COMPLETE),r.trigger("uploadSuccess",e,t,n)}).fail(function(t){e.getStatus()===f.PROGRESS&&e.setStatus(f.ERROR,t),r.trigger("uploadError",e,t)}).always(function(){r.trigger("uploadComplete",e)})}})}),t("widgets/queue",["base","uploader","queue","file"],function(e,t,n,r){var i=e.$,o=(e.log,/\.\w+$/),a=r.Status;return t.register({"sort-files":"sortFiles","add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset"},{init:function(t){var r,i,o,a,s,u,c=this;if(t.accept){for(s=[],o=0,i=t.accept.length;i>o;o++)a=t.accept[o].extensions,a&&s.push(a);s.length&&(u="\\."+s.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$"),c.accept=new RegExp(u,"i")}return c.queue=new n,c.stats=c.queue.stats,r=e.Deferred(),r.resolve(),r.promise()},_wrapFile:function(e){return e instanceof r||(e=new r(e)),e},_addFile:function(e){var t,n=this,r=n.owner.options;return!e||e.size<6||n.accept&&o.exec(e.name)&&!n.accept.test(e.name)?(t=r.accept[0].extensions,n.owner.trigger("error","F_TYPE_INVALID",t,e),void 0):(e=n._wrapFile(e),n.owner.trigger("beforeFileQueued",e)?(n.queue.append(e),n.owner.trigger("fileQueued",e),e):void 0)},getFile:function(e){return this.queue.getFile(e)},addFiles:function(e){var t=this;e.length||(e=[e]),e=i.map(e,function(e){return t._addFile(e)}),t.owner.trigger("filesQueued",e),t.options.auto&&t.request("start-upload")},getStats:function(){return this.stats},removeFile:function(e){var t=this;e=e.id?e:t.queue.getFile(e),e.setStatus(a.CANCELLED),t.owner.trigger("fileDequeued",e)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(e){var t,n,r,i=this;if(e)return e=e.id?e:i.queue.getFile(e),e.setStatus(a.QUEUED),i.request("start-upload"),void 0;for(t=i.queue.getFiles(a.ERROR),n=0,r=t.length;r>n;n++)e=t[n],e.setStatus(a.QUEUED);i.request("start-upload")},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.queue=new n,this.stats=this.queue.stats}})}),t("widgets/validator",["base","uploader","file"],function(e,t,n){var r,i=e.$,o={};return r={addValidator:function(e,t){o[e]=t},removeValidator:function(e){delete o[e]}},t.register({init:function(){var e=this;i.each(o,function(){this.call(e.owner)})}}),r.addValidator("fileNumLimit",function(){var e=this,t=e.options,n=0,r=t.fileNumLimit>>0,i=!0;r&&(e.on("beforeFileQueued",function(){return n>=r&&i&&(i=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",r),setTimeout(function(){i=!0},1)),n>=r?!1:!0}),e.on("fileQueued",function(){n++}),e.on("fileDequeued",function(){n--}),e.on("uploadFinished",function(){n=0}))}),r.addValidator("fileSizeLimit",function(){var e=this,t=e.options,n=0,r=t.fileSizeLimit>>0,i=!0;r&&(e.on("beforeFileQueued",function(e){var t=n+e.size>r;return t&&i&&(i=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",r),setTimeout(function(){i=!0},1)),t?!1:!0}),e.on("fileQueued",function(e){n+=e.size}),e.on("fileDequeued",function(e){n-=e.size}),e.on("uploadFinished",function(){n=0}))}),r.addValidator("fileSingleSizeLimit",function(){var e=this,t=e.options,r=t.fileSingleSizeLimit;r&&e.on("beforeFileQueued",function(e){return e.size>r?(e.setStatus(n.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",r,e),!1):void 0})}),r.addValidator("duplicate",function(){function e(e){for(var t,n=0,r=0,i=e.length;i>r;r++)t=e.charCodeAt(r),n=t+(n<<6)+(n<<16)-n;return n}var t=this,n=t.options,r={};n.duplicate||(t.on("beforeFileQueued",function(t){var n=t.__hash||(t.__hash=e(t.name+t.size+t.lastModifiedDate));return r[n]?(this.trigger("error","F_DUPLICATE"),!1):void 0}),t.on("fileQueued",function(e){var t=e.__hash;t&&(r[t]=!0)}),t.on("fileDequeued",function(e){var t=e.__hash;t&&delete r[t]}))}),r}),t("webuploader",["base"],function(e){return e}),n("webuploader")});